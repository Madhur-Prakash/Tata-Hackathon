<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStreetMap Demo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; width: 100%; }

        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 15px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #005a87;
        }
        
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            min-width: 200px;
        }
        
        .info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 5px;
            border-left: 4px solid #007cba;
        }
    </style>
</head>
<body>
    <script>
    function loadLeaflet(callback) {
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js";
        script.onload = callback;
        document.head.appendChild(script);
    }

    window.onload = function () {
        loadLeaflet(function () {
            initMap(); // Now Leaflet (L) is guaranteed to be defined
        });
    };
</script>

<script>
let map; // Declare globally

function initMap() {
    map = L.map('map').setView([51.505, -0.09], 13); // Assign inside function
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    
        // Add click event to map
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`<b>Coordinates:</b><br>Lat: ${lat.toFixed(5)}<br>Lng: ${lng.toFixed(5)}`);
            markers.push(marker);
        });

}

</script>

    
    <div class="container">
        <h1>üó∫Ô∏è OpenStreetMap Interactive Demo</h1>
        
        <div id="map"></div>
        
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search for a location..." />
            <button onclick="searchLocation()">Search</button>
            <button onclick="addMarker()">Add Marker</button>
            <button onclick="clearMarkers()">Clear Markers</button>
            <button onclick="getCurrentLocation()">My Location</button>
        </div>
        
        <div class="info">
            <strong>Features:</strong> Click on the map to add markers, use the search to find locations, 
            or click "My Location" to center on your position. You can zoom and pan around the map freely.
        </div>
    </div>
    <input type="number" id="batteryInput" placeholder="Battery level (%)" min="0" max="100" style="width: 150px;" />
<button onclick="updateBatteryLevel()">Set Battery</button>
<div class="controls">
    <input type="text" id="searchInput" placeholder="Search for a location..." />
    <button onclick="searchLocation()">Search</button>
    <button onclick="addMarker()">Add Marker</button>
    <button onclick="clearMarkers()">Clear Markers</button>
    <button onclick="getCurrentLocation()">My Location</button>
    <input type="number" id="batteryInput" placeholder="Battery level (%)" min="0" max="100" style="width: 150px;" />
    <button onclick="updateBatteryLevel()">Set Battery</button>
</div>



    <script>
        function updateBatteryLevel() {
    const input = document.getElementById('batteryInput').value;
    const value = parseInt(input);

    if (!isNaN(value) && value >= 0 && value <= 100) {
        batteryLevel = value;
        alert(`üîã Battery level set to ${batteryLevel}%`);
    } else {
        alert('Please enter a valid battery level between 0 and 100.');
    }
}

    let lastPosition = null;
    const speedDisplay = document.createElement('div');
    speedDisplay.style.marginTop = '10px';
    speedDisplay.style.fontWeight = 'bold';
    document.querySelector('.info').appendChild(speedDisplay);

    // Simulate or collect battery level (in real use, get from OBD or input)
    let batteryLevel = 22; // Sample low battery

    function startTracking() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(async function(position) {
                const { latitude: lat, longitude: lng } = position.coords;

                // Calculate speed
                if (lastPosition) {
                    const dist = haversine(lastPosition.lat, lastPosition.lng, lat, lng);
                    const timeDiff = (position.timestamp - lastPosition.timestamp) / 1000; // seconds
                    const speedMps = dist / timeDiff;
                    const speedKmph = speedMps * 3.6;
                    speedDisplay.textContent = `üöó Current Speed: ${speedKmph.toFixed(2)} km/h`;
                }

                lastPosition = {
                    lat,
                    lng,
                    timestamp: position.timestamp
                };

                // Send battery level and location to backend - FIXED URL
                try {
                    const response = await fetch('http://localhost:8000/api/location/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lat,
                            lng,
                            batteryLevel
                        })
                    });

                    const data = await response.json();
                    if (data.redirectToChargingStation && data.station) {
                        const { lat: clat, lon: clon, name } = data.station;
                        map.setView([clat, clon], 15);
                        const marker = L.marker([clat, clon]).addTo(map);
                        marker.bindPopup(`<b>üîã Nearest Charging Station</b><br>${name}`).openPopup();
                        markers.push(marker);
                    }
                } catch (error) {
                    console.error('Error updating location:', error);
                }

            }, function(err) {
                alert('Failed to track location: ' + err.message);
            }, { enableHighAccuracy: true, maximumAge: 1000 });
        } else {
            alert("Geolocation not supported.");
        }
    }

    // Call it on load
    startTracking();

    // Haversine formula
    function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371000; // meters
        const toRad = (deg) => deg * Math.PI / 180;

        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // in meters
    }

      
        // Store markers
        let markers = [];

        // Search for location
        async function searchLocation() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    map.setView([lat, lng], 15);
                    
                    const marker = L.marker([lat, lng]).addTo(map);
                    marker.bindPopup(`<b>${result.display_name}</b>`).openPopup();
                    markers.push(marker);
                } else {
                    alert('Location not found!');
                }
            } catch (error) {
                alert('Error searching location: ' + error.message);
            }
        }

        // Add marker at map center
        function addMarker() {
            const center = map.getCenter();
            const marker = L.marker([center.lat, center.lng]).addTo(map);
            marker.bindPopup(`<b>Manual Marker</b><br>Lat: ${center.lat.toFixed(5)}<br>Lng: ${center.lng.toFixed(5)}`);
            markers.push(marker);
        }

        // Clear all markers
        function clearMarkers() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
        }

        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    map.setView([lat, lng], 15);
                    
                    const marker = L.marker([lat, lng]).addTo(map);
                    marker.bindPopup('<b>Your Location</b>').openPopup();
                    markers.push(marker);
                }, function() {
                    alert('Unable to get your location');
                });
            } else {
                alert('Geolocation is not supported by this browser');
            }
        }

        // Allow Enter key for search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });
    </script>
</body>
</html>